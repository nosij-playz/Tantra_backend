<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>View Participants - Premium Admin</title>
<link rel="stylesheet" href="/static/css/admin.css" />
<link rel="icon" href="{{ url_for('static', filename='logos/log.png') }}" type="image/png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="container floating">
    <div class="header">
      <div class="brand">
<img src="{{ url_for('static', filename='logos/log.png') }}" alt="Logo" style="width: 40px; height: 40px;">        <div>
          <h1>Tantra Admin</h1>
          <div class="small">Manage registered participants</div>
        </div>
      </div>
      <div class="controls">
        <a href="/index" class="btn btn-ghost"><i class="fas fa-arrow-left"></i> Dashboard</a>
        <a href="/add_event" class="btn btn-primary"><i class="fas fa-plus"></i> Add Event</a>
      </div>
    </div>

    <div class="card">
      <form method="GET" class="form-row">
        <div class="form-group">
          <label><i class="fas fa-filter"></i> Select Department:</label>
          <select name="dept_id" id="deptSelect" onchange="this.form.submit()">
            <option value="">-- Select Department --</option>
            {% for id, name in departments %}
              <option value="{{ id }}" {% if selected_dept_id == id %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
          </select>
        </div>
      </form>

      <div class="toolbar">
        <div class="left">
          <div class="form-group" style="min-width: 300px; margin: 0;">
            <input class="search" id="participantSearch" placeholder="Search name, email, college..." />
          </div>
          {% if participants %}
            <button class="copy-btn" id="copyBtn"><i class="fas fa-copy"></i> Copy Data</button>
          {% endif %}
        </div>
      </div>

      {% if events_for_select %}
      <form method="GET" id="eventFilterForm" class="form-row">
        <input type="hidden" name="dept_id" value="{{ selected_dept_id }}" />
        <div class="form-group">
          <label><i class="fas fa-calendar-alt"></i> Select Event (optional):</label>
          <select name="event_id" onchange="document.getElementById('eventFilterForm').submit()">
            <option value="">-- All Events --</option>
            {% for eid, ename in events_for_select %}
              <option value="{{ ename }}" {% if selected_event_id == ename %}selected{% endif %}>{{ ename }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group" style="display: flex; align-items: flex-end;">
          <label style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" name="sort_event" value="1" {% if request.args.get('sort_event') == '1' %}checked{% endif %} />
            <span>Sort by event</span>
          </label>
        </div>
      </form>
      {% endif %}

      <div class="toolbar">
        <div class="left">
          <a href="/view_participants?dept_id={{ selected_dept_id }}&event_id={{ selected_event_id }}" class="btn btn-ghost"><i class="fas fa-sync-alt"></i> Refresh</a>
          {% if participants %}
          <label style="margin-left:12px; display:inline-flex; align-items:center; gap:8px; font-size:14px;">
            <input type="checkbox" id="downloadSortByEvent" />
            <span>Sort downloaded file by Event</span>
          </label>
          <button id="serverExportXlsxBtn" class="btn btn-success"><i class="fas fa-file-excel"></i> Download XLSX</button>
          <button id="serverExportPdfBtn" class="btn btn-primary"><i class="fas fa-file-pdf"></i> Download PDF</button>
          {% endif %}
        </div>
      </div>

      {% if participants %}
      <div class="table-wrap">
        <table id="participantsTable">
          <thead>
            <tr>
              <th><i class="fas fa-user"></i> Name</th>
              <th><i class="fas fa-envelope"></i> Email</th>
              <th><i class="fas fa-phone"></i> Phone</th>
              <th><i class="fas fa-university"></i> College</th>
              <th><i class="fas fa-code-branch"></i> Branch</th>
              <th><i class="fas fa-graduation-cap"></i> Year</th>
              <th><i class="fas fa-calendar-check"></i> Event</th>
              <th><i class="fas fa-receipt"></i> Transaction ID</th>
            </tr>
          </thead>
          <tbody>
          {% for p in participants %}
          <tr>
            <td data-label="Name">{{ (p['name'] if p['name'] and p['name']|string != 'None' else '-') }}</td>
            <td data-label="Email">{{ (p['email'] if p['email'] and p['email']|string != 'None' else '-') }}</td>
            <td data-label="Phone">{{ (p['phone'] if p['phone'] and p['phone']|string != 'None' else '-') }}</td>
            <td data-label="College">{{ (p['college'] if p['college'] and p['college']|string != 'None' else '-') }}</td>
            <td data-label="Branch">{{ (p['branch'] if p['branch'] and p['branch']|string != 'None' else '-') }}</td>
            <td data-label="Year">{{ (p['year'] if p['year'] and p['year']|string != 'None' else '-') }}</td>
            <td data-label="Event"><span class="badge">{{ (p['event_name'] if p['event_name'] and p['event_name']|string != 'None' else '-') }}</span></td>
            <td data-label="Transaction ID"><code>{{ (p['transaction_id'] if p['transaction_id'] and p['transaction_id']|string != 'None' else '-') }}</code></td>
          </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="no-data">
        <i class="fas fa-users-slash" style="font-size: 48px; margin-bottom: 16px; color: var(--muted);"></i>
        <p>No participants registered for this department.</p>
      </div>
      {% endif %}

      <a href="/index" class="back-link"><i class="fas fa-arrow-left"></i> Back to Admin Panel</a>
    </div>
  </div>

  <script>
    // Enhanced client-side filtering
    const search = document.getElementById('participantSearch');
    if (search) {
      search.addEventListener('input', function(){
        const q = this.value.toLowerCase();
        let visibleCount = 0;
        
        document.querySelectorAll('#participantsTable tbody tr').forEach(tr => {
          const text = tr.innerText.toLowerCase();
          const isVisible = text.includes(q);
          tr.style.display = isVisible ? '' : 'none';
          if (isVisible) visibleCount++;
        });
        
        // Update results count in search placeholder
        if (q.length > 0) {
          search.setAttribute('data-results', `${visibleCount} results`);
        } else {
          search.removeAttribute('data-results');
        }
      });
    }
    
    // Enhanced copy button with feedback
    const copyBtn = document.getElementById('copyBtn');
    if (copyBtn) {
      copyBtn.addEventListener('click', function(e){
        e.preventDefault();
        
        // Add loading state
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Copying...';
        this.disabled = true;
        
        let txt = '';
        const headers = Array.from(document.querySelectorAll('#participantsTable thead th'))
          .map(th => th.innerText.replace(/[^a-zA-Z0-9 ]/g, ''))
          .join('\t');
        txt += headers + '\n';
        
        document.querySelectorAll('#participantsTable tbody tr').forEach(tr => { 
          if (tr.style.display !== 'none') {
            txt += Array.from(tr.cells).map(td => td.innerText).join('\t') + '\n'; 
          }
        });
        
        navigator.clipboard.writeText(txt).then(() => { 
          this.innerHTML = '<i class="fas fa-check"></i> Copied!';
          setTimeout(() => {
            this.innerHTML = originalText;
            this.disabled = false;
          }, 2000);
        }).catch(() => { 
          this.innerHTML = '<i class="fas fa-times"></i> Failed';
          setTimeout(() => {
            this.innerHTML = originalText;
            this.disabled = false;
          }, 2000);
        });
      });
    }

    // Helper: collect visible table headers and rows (as arrays of strings)
    function getVisibleTableData() {
      const headers = Array.from(document.querySelectorAll('#participantsTable thead th'))
        .map(th => th.innerText.replace(/[^\w \-]/g, '').trim());
      const rows = [];
      document.querySelectorAll('#participantsTable tbody tr').forEach(tr => {
        if (tr.style.display === 'none') return;
        const cells = Array.from(tr.cells).map(td => td.innerText.trim());
        rows.push(cells);
      });
      return { headers, rows };
    }

    // Server-backed visible exports: POST visible rows to server to generate PDF/XLSX
    const serverExportPdfBtn = document.getElementById('serverExportPdfBtn');
    if (serverExportPdfBtn) {
      serverExportPdfBtn.addEventListener('click', async function(e){
        e.preventDefault();
        const { headers, rows: rawRows } = getVisibleTableData();
        // clone rows before mutating
        const rows = rawRows.slice();
        // if the user requested sorting by event for the downloaded file, sort client-side by the Event column
        try {
          const sortByEvent = document.getElementById('downloadSortByEvent')?.checked;
          if (sortByEvent) {
            const idx = headers.findIndex(h => /event/i.test(h));
            if (idx >= 0) {
              rows.sort((a,b) => ((a[idx]||'').toString().toLowerCase()).localeCompare((b[idx]||'').toString().toLowerCase()));
            }
          }
        } catch (err) {
          console.warn('Failed to sort rows before PDF export', err);
        }
        try {
          const resp = await fetch('/export_visible_pdf', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ headers: headers, rows: rows, title: 'Participants' })
          });
          if (!resp.ok) { alert('Failed to generate PDF'); return; }
          const blob = await resp.blob();
          const url = URL.createObjectURL(blob);
            // determine filename according to selected filters
            const filenameBase = (function(){
              // get department and event values from the page (hidden inputs / selects)
              // deptSelect contains dept id; try to get the dept name from the selected option if available
              const deptSelect = document.getElementById('deptSelect');
              let deptName = '';
              if (deptSelect) {
                const opt = deptSelect.options[deptSelect.selectedIndex];
                if (opt && opt.value) deptName = opt.text.trim();
              }
              // event select might be in the form with name event_id; find it by name
              let eventName = '';
              const eventSelect = document.querySelector('select[name="event_id"]');
              if (eventSelect) {
                const opt = eventSelect.options[eventSelect.selectedIndex];
                if (opt && opt.value) eventName = opt.text.trim();
              }

              // apply rules: none -> allparticipants, dept only -> dept, event only -> event, both -> dept_event
              if (!deptName && !eventName) return 'allparticipants';
              if (deptName && !eventName) return deptName;
              if (!deptName && eventName) return eventName;
              return deptName + '_' + eventName;
            })();

            // sanitize filename: replace spaces with underscores, remove dangerous chars
            const sanitize = s => s.replace(/\s+/g, '_').replace(/[^A-Za-z0-9_\-\.]/g, '');
            const fname = sanitize(filenameBase) + '.pdf';
            const a = document.createElement('a'); a.href = url; a.download = fname; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        } catch(err) { alert('Error exporting PDF: '+err.message); }
      });
    }

    const serverExportXlsxBtn = document.getElementById('serverExportXlsxBtn');
    if (serverExportXlsxBtn) {
      serverExportXlsxBtn.addEventListener('click', async function(e){
        e.preventDefault();
        const { headers, rows: rawRows } = getVisibleTableData();
        const rows = rawRows.slice();
        try {
          const sortByEvent = document.getElementById('downloadSortByEvent')?.checked;
          if (sortByEvent) {
            const idx = headers.findIndex(h => /event/i.test(h));
            if (idx >= 0) {
              rows.sort((a,b) => ((a[idx]||'').toString().toLowerCase()).localeCompare((b[idx]||'').toString().toLowerCase()));
            }
          }
        } catch (err) {
          console.warn('Failed to sort rows before XLSX export', err);
        }
        try {
          const resp = await fetch('/export_visible_xlsx', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ headers: headers, rows: rows, title: 'Participants' })
          });
          if (!resp.ok) { alert('Failed to generate XLSX'); return; }
          const blob = await resp.blob();
          const url = URL.createObjectURL(blob);
          // determine filename according to selected filters (same logic as PDF)
          const filenameBase = (function(){
            const deptSelect = document.getElementById('deptSelect');
            let deptName = '';
            if (deptSelect) {
              const opt = deptSelect.options[deptSelect.selectedIndex];
              if (opt && opt.value) deptName = opt.text.trim();
            }
            let eventName = '';
            const eventSelect = document.querySelector('select[name="event_id"]');
            if (eventSelect) {
              const opt = eventSelect.options[eventSelect.selectedIndex];
              if (opt && opt.value) eventName = opt.text.trim();
            }
            if (!deptName && !eventName) return 'allparticipants';
            if (deptName && !eventName) return deptName;
            if (!deptName && eventName) return eventName;
            return deptName + '_' + eventName;
          })();
          const sanitize = s => s.replace(/\s+/g, '_').replace(/[^A-Za-z0-9_\-\.]/g, '');
          const fname = sanitize(filenameBase) + '.xlsx';
          const a = document.createElement('a'); a.href = url; a.download = fname; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        } catch(err) { alert('Error exporting XLSX: '+err.message); }
      });
    }
  </script>
  <script>
    // Hide any stray fixed-position element anchored to bottom-left (unwanted download button)
    (function(){
      try {
        const els = Array.from(document.querySelectorAll('body *'));
        els.forEach(el => {
          const style = window.getComputedStyle(el);
          if (style.position === 'fixed') {
            const r = el.getBoundingClientRect();
            // check if it's near bottom-left corner (within 120px of left and 120px of bottom)
            if (r.left >= 0 && r.left <= 140 && (window.innerHeight - (r.top + r.height)) >= -10 && (window.innerHeight - (r.top + r.height)) <= 140) {
              // hide it
              el.style.display = 'none';
              el.setAttribute('data-hidden-by', 'admin-cleanup');
            }
          }
        });
      } catch(e) {
        // noop
        console.warn('cleanup script failed', e);
      }
    })();
  </script>
</body>
</html>
